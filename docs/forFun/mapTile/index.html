<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Santa Cruz Explorer</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Archivo+Black&family=Space+Mono:wght@400;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        body {
            overflow: hidden;
            background: #0a0a0f;
            font-family: 'Space Mono', monospace
        }

        canvas {
            display: block
        }

        /* ‚îÄ‚îÄ Start Screen ‚îÄ‚îÄ */
        #start-screen {
            position: fixed;
            inset: 0;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(145deg, #0a0a12, #1a0f22 40%, #2d1424 70%, #3d1a1a)
        }

        #start-screen::before {
            content: '';
            position: absolute;
            inset: 0;
            pointer-events: none;
            background: radial-gradient(ellipse 120% 60% at 50% 110%, rgba(255, 120, 50, .12) 0%, transparent 70%),
                radial-gradient(circle at 80% 20%, rgba(100, 60, 180, .08) 0%, transparent 50%)
        }

        .sc {
            position: relative;
            z-index: 1;
            text-align: center;
            max-width: 520px;
            padding: 0 24px
        }

        .sc h1 {
            font-family: 'Archivo Black', sans-serif;
            font-size: clamp(2.4rem, 6vw, 3.6rem);
            color: #fff;
            letter-spacing: -.02em;
            line-height: 1.05;
            margin-bottom: 6px;
            text-shadow: 0 0 60px rgba(255, 100, 40, .25)
        }

        .sc h1 span {
            display: block;
            background: linear-gradient(90deg, #ff8844, #ff5566, #cc66ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text
        }

        .sc .sub {
            font-size: .72rem;
            color: rgba(255, 255, 255, .35);
            letter-spacing: .35em;
            text-transform: uppercase;
            margin-bottom: 40px
        }

        .api-box {
            background: rgba(255, 255, 255, .04);
            border: 1px solid rgba(255, 255, 255, .08);
            border-radius: 16px;
            padding: 28px 24px;
            backdrop-filter: blur(20px)
        }

        .api-box label {
            display: block;
            font-size: .7rem;
            color: rgba(255, 255, 255, .45);
            letter-spacing: .15em;
            text-transform: uppercase;
            margin-bottom: 10px;
            text-align: left
        }

        .api-box input {
            width: 100%;
            padding: 14px 16px;
            background: rgba(0, 0, 0, .4);
            border: 1px solid rgba(255, 255, 255, .1);
            border-radius: 10px;
            color: #fff;
            font-family: 'Space Mono', monospace;
            font-size: .85rem;
            outline: none;
            transition: border-color .3s
        }

        .api-box input::placeholder {
            color: rgba(255, 255, 255, .2)
        }

        .api-box input:focus {
            border-color: rgba(255, 136, 68, .5)
        }

        .api-box .hint {
            font-size: .65rem;
            color: rgba(255, 255, 255, .25);
            margin-top: 8px;
            text-align: left;
            line-height: 1.5
        }

        .api-box .hint a {
            color: rgba(255, 136, 68, .7);
            text-decoration: none
        }

        #start-btn {
            margin-top: 24px;
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #ff7744, #ee4466);
            border: none;
            border-radius: 12px;
            color: #fff;
            font-family: 'Archivo Black', sans-serif;
            font-size: 1rem;
            letter-spacing: .08em;
            cursor: pointer;
            transition: all .3s;
            text-transform: uppercase
        }

        #start-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(255, 80, 60, .35)
        }

        #start-btn:disabled {
            opacity: .4;
            cursor: not-allowed;
            transform: none;
            box-shadow: none
        }

        /* ‚îÄ‚îÄ Loading ‚îÄ‚îÄ */
        #loading {
            position: fixed;
            inset: 0;
            z-index: 90;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(10, 10, 15, .95);
            backdrop-filter: blur(10px)
        }

        #loading.on {
            display: flex
        }

        .ld-spin {
            width: 48px;
            height: 48px;
            margin: 0 auto 20px;
            border: 3px solid rgba(255, 255, 255, .1);
            border-top-color: #ff7744;
            border-radius: 50%;
            animation: sp .8s linear infinite
        }

        @keyframes sp {
            to {
                transform: rotate(360deg)
            }
        }

        .ld-c {
            text-align: center
        }

        .ld-c p {
            color: rgba(255, 255, 255, .5);
            font-size: .8rem
        }

        #ld-status {
            color: rgba(255, 255, 255, .35);
            font-size: .7rem;
            margin-top: 8px
        }

        /* ‚îÄ‚îÄ HUD ‚îÄ‚îÄ */
        #hud {
            position: fixed;
            inset: 0;
            z-index: 10;
            pointer-events: none;
            display: none
        }

        #hud.on {
            display: block
        }

        .cross {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 24px;
            height: 24px
        }

        .cross::before,
        .cross::after {
            content: '';
            position: absolute;
            background: rgba(255, 255, 255, .5);
            border-radius: 2px
        }

        .cross::before {
            width: 2px;
            height: 14px;
            top: 5px;
            left: 11px
        }

        .cross::after {
            width: 14px;
            height: 2px;
            top: 11px;
            left: 5px
        }

        .hp {
            background: rgba(0, 0, 0, .55);
            border: 1px solid rgba(255, 255, 255, .08);
            border-radius: 12px;
            padding: 14px 18px;
            backdrop-filter: blur(10px)
        }

        .h-info {
            position: absolute;
            top: 24px;
            left: 24px
        }

        .h-info .t {
            font-family: 'Archivo Black', sans-serif;
            font-size: .9rem;
            color: #fff;
            margin-bottom: 4px
        }

        .h-info .c {
            font-size: .65rem;
            color: rgba(255, 255, 255, .35);
            letter-spacing: .05em
        }

        .h-ctrl {
            position: absolute;
            bottom: 24px;
            left: 24px;
            padding: 16px 20px
        }

        .h-ctrl h3 {
            font-family: 'Archivo Black', sans-serif;
            font-size: .65rem;
            color: rgba(255, 255, 255, .4);
            letter-spacing: .2em;
            text-transform: uppercase;
            margin-bottom: 10px
        }

        .kr {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
            font-size: .72rem;
            color: rgba(255, 255, 255, .55)
        }

        .k {
            display: inline-block;
            padding: 2px 7px;
            background: rgba(255, 255, 255, .1);
            border: 1px solid rgba(255, 255, 255, .15);
            border-radius: 4px;
            font-size: .65rem;
            color: rgba(255, 255, 255, .7);
            font-family: 'Space Mono', monospace;
            min-width: 24px;
            text-align: center
        }

        .h-spd {
            position: absolute;
            bottom: 24px;
            right: 24px;
            text-align: center
        }

        .h-spd .v {
            font-family: 'Archivo Black', sans-serif;
            font-size: 1.5rem;
            color: #ff8844
        }

        .h-spd .u {
            font-size: .6rem;
            color: rgba(255, 255, 255, .3);
            letter-spacing: .15em;
            text-transform: uppercase
        }

        .h-tiles {
            position: absolute;
            top: 24px;
            right: 24px;
            font-size: .65rem;
            color: rgba(255, 255, 255, .35)
        }

        .cmsg {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: rgba(255, 255, 255, .7);
            font-size: .85rem;
            background: rgba(0, 0, 0, .6);
            padding: 14px 28px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, .1);
            backdrop-filter: blur(10px);
            transition: opacity .3s
        }

        .cmsg.hide {
            opacity: 0;
            pointer-events: none
        }

        /* ‚îÄ‚îÄ Debug Panel ‚îÄ‚îÄ */
        #dbg {
            position: fixed;
            top: 80px;
            right: 10px;
            z-index: 200;
            background: rgba(0, 0, 0, .85);
            color: #0f0;
            font-size: 11px;
            font-family: monospace;
            padding: 10px 14px;
            border-radius: 8px;
            max-width: 400px;
            max-height: 60vh;
            overflow-y: auto;
            pointer-events: auto;
            line-height: 1.5;
            border: 1px solid rgba(0, 255, 0, .15);
            display: none;
        }

        #dbg.on {
            display: block
        }

        #dbg .err {
            color: #f55
        }

        #dbg .warn {
            color: #fa0
        }

        #dbg .ok {
            color: #0f0
        }

        #dbg-toggle {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 201;
            background: rgba(0, 0, 0, .7);
            color: #0f0;
            border: 1px solid rgba(0, 255, 0, .3);
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 11px;
            font-family: monospace;
            cursor: pointer;
            display: none;
        }

        #dbg-toggle.on {
            display: block
        }
    </style>
</head>

<body>

    <div id="start-screen">
        <div class="sc">
            <h1>SANTA CRUZ<span>EXPLORER</span></h1>
            <p class="sub">Walk the streets in photorealistic 3D</p>
            <div class="api-box">
                <label>Google Maps API Key</label>
                <input type="text" id="api-key" placeholder="AIza..." spellcheck="false" autocomplete="off">
                <p class="hint">Requires <strong>Map Tiles API</strong> enabled. <a
                        href="https://console.cloud.google.com/apis/library/tile.googleapis.com" target="_blank">Get a
                        key ‚Üí</a></p>
            </div>
            <button id="start-btn" disabled>Enter Santa Cruz</button>
        </div>
    </div>

    <div id="loading">
        <div class="ld-c">
            <div class="ld-spin"></div>
            <p>Loading photorealistic tiles‚Ä¶</p>
            <p id="ld-status">Initializing</p>
        </div>
    </div>

    <div id="hud">
        <div class="cross"></div>
        <div class="h-info hp">
            <div class="t">Santa Cruz, CA</div>
            <div class="c" id="coords">36.9641¬∞N 122.0178¬∞W</div>
        </div>
        <div class="h-ctrl hp">
            <h3>Controls</h3>
            <div class="kr"><span class="k">W</span><span class="k">A</span><span class="k">S</span><span
                    class="k">D</span> Move</div>
            <div class="kr"><span class="k">‚áß</span> Sprint</div>
            <div class="kr"><span class="k">Space</span>/<span class="k">Q</span> Up / Down</div>
            <div class="kr"><span class="k">Mouse</span> Look</div>
            <div class="kr"><span class="k">Esc</span> Release</div>
        </div>
        <div class="h-spd hp">
            <div class="v" id="spd">0</div>
            <div class="u">m/s</div>
        </div>
        <div class="h-tiles hp" id="htiles">Tiles: 0</div>
        <div class="cmsg" id="cmsg">Click to start exploring</div>
    </div>

    <button id="dbg-toggle" onclick="document.getElementById('dbg').classList.toggle('on')">Debug ‚ñº</button>
    <div id="dbg"></div>

    <!-- 
  Import strategy: Use esm.sh with ?external=three so that 3d-tiles-renderer 
  uses the SAME Three.js instance as our code (resolved via importmap).
-->
    <script type="importmap">
{
  "imports": {
    "three": "https://esm.sh/three@0.169.0",
    "three/": "https://esm.sh/three@0.169.0/",
    "3d-tiles-renderer": "https://esm.sh/3d-tiles-renderer@0.4.21?external=three"
  }
}
</script>

    <script type="module">
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //  Debug Logger
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const dbgEl = document.getElementById('dbg');
        const dbgBtn = document.getElementById('dbg-toggle');
        function dbg(msg, type = 'ok') {
            console.log(`[SC:${type}]`, msg);
            const d = document.createElement('div');
            d.className = type;
            d.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            dbgEl.prepend(d);
            // Keep max 80 lines
            while (dbgEl.children.length > 80) dbgEl.lastChild.remove();
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //  Step 1: Import Libraries with error catching
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        let THREE, TilesRenderer, GoogleCloudAuthPlugin;

        try {
            dbg('Importing Three.js...');
            THREE = await import('three');
            dbg(`Three.js r${THREE.REVISION} loaded ‚úì`);
            if (parseInt(THREE.REVISION) < 167) {
                dbg(`Warning: Three.js version might be too old (r${THREE.REVISION})`, 'warn');
            }
        } catch (e) {
            dbg(`FATAL: Three.js import failed: ${e.message}`, 'err');
            alert('Failed to load Three.js: ' + e.message);
            throw e;
        }

        try {
            dbg('Importing 3d-tiles-renderer...');
            const tilesModule = await import('3d-tiles-renderer');
            dbg(`3d-tiles-renderer loaded. Exports: ${Object.keys(tilesModule).join(', ')}`, 'ok');

            TilesRenderer = tilesModule.TilesRenderer;
            GoogleCloudAuthPlugin = tilesModule.GoogleCloudAuthPlugin;

            if (!TilesRenderer) {
                dbg('TilesRenderer not found in exports!', 'err');
                throw new Error('TilesRenderer not exported');
            }
            if (!GoogleCloudAuthPlugin) {
                dbg('GoogleCloudAuthPlugin not found ‚Äî will try manual URL approach', 'warn');
            }
            dbg('TilesRenderer ready ‚úì');
        } catch (e) {
            dbg(`3d-tiles-renderer import failed: ${e.message}`, 'err');
            dbg('Stack: ' + e.stack, 'err');
            alert('Failed to load 3d-tiles-renderer: ' + e.message + '\n\nCheck browser console for details.');
            throw e;
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //  WGS84 Helpers
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const WA = 6378137, WF = 1 / 298.257223563, WE2 = 2 * WF - WF * WF;

        function g2e(lat, lng, alt) {
            const r = lat * Math.PI / 180, g = lng * Math.PI / 180, s = Math.sin(r), c = Math.cos(r);
            const N = WA / Math.sqrt(1 - WE2 * s * s);
            return new THREE.Vector3((N + alt) * c * Math.cos(g), (N + alt) * c * Math.sin(g), (N * (1 - WE2) + alt) * s);
        }
        function e2g(x, y, z) {
            const ln = Math.atan2(y, x), p = Math.sqrt(x * x + y * y);
            let la = Math.atan2(z, p * (1 - WE2));
            for (let i = 0; i < 6; i++) { const s = Math.sin(la), N = WA / Math.sqrt(1 - WE2 * s * s); la = Math.atan2(z + WE2 * N * s, p); }
            const s = Math.sin(la), N = WA / Math.sqrt(1 - WE2 * s * s);
            return { lat: la * 180 / Math.PI, lng: ln * 180 / Math.PI, alt: p / Math.cos(la) - N };
        }
        function enuMat(lat, lng, alt) {
            const r = lat * Math.PI / 180, g = lng * Math.PI / 180;
            const sl = Math.sin(r), cl = Math.cos(r), sg = Math.sin(g), cg = Math.cos(g);
            const e = new THREE.Vector3(-sg, cg, 0), n = new THREE.Vector3(-sl * cg, -sl * sg, cl), u = new THREE.Vector3(cl * cg, cl * sg, sl);
            const m = new THREE.Matrix4().makeBasis(e, u, n.clone().negate());
            m.setPosition(g2e(lat, lng, alt)); return m;
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //  Constants & State
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const LAT = 36.9641, LNG = -122.0178, ALT = 100;
        const SPD = 14, SPRINT = 3, SENS = 0.002;

        const $ = id => document.getElementById(id);
        let renderer, scene, camera, clock, tiles, pivotMat;
        const keys = {};
        let pitch = 0, yaw = Math.PI, vel = new THREE.Vector3(), locked = false;

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //  UI Setup
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const apiIn = $('api-key'), startBtn = $('start-btn');
        apiIn.addEventListener('input', () => { startBtn.disabled = apiIn.value.trim().length < 10; });
        startBtn.addEventListener('click', () => launch(apiIn.value.trim()));

        function status(m) { $('ld-status').textContent = m; dbg(m); }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //  Main Launch
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        async function launch(apiKey) {
            $('start-screen').style.display = 'none';
            $('loading').classList.add('on');
            dbgBtn.classList.add('on');

            try {
                // ‚îÄ‚îÄ Renderer ‚îÄ‚îÄ
                status('Creating WebGL renderer‚Ä¶');
                renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: 'high-performance' });
                renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
                renderer.setSize(innerWidth, innerHeight);
                renderer.outputColorSpace = THREE.SRGBColorSpace;
                renderer.toneMapping = THREE.ACESFilmicToneMapping;
                renderer.toneMappingExposure = 1.2;
                document.body.prepend(renderer.domElement);
                dbg('Renderer created ‚úì');

                // ‚îÄ‚îÄ Scene ‚îÄ‚îÄ
                scene = new THREE.Scene();
                scene.background = new THREE.Color(0x7cb5e8);
                scene.fog = new THREE.FogExp2(0x7cb5e8, 0.00002);

                camera = new THREE.PerspectiveCamera(72, innerWidth / innerHeight, 1, 500000);
                camera.position.set(0, ALT, 0);
                clock = new THREE.Clock();

                // ‚îÄ‚îÄ Lighting ‚îÄ‚îÄ
                scene.add(new THREE.AmbientLight(0xffffff, 0.8));
                const sun = new THREE.DirectionalLight(0xfff8ee, 2.0);
                sun.position.set(500, 1000, 600);
                scene.add(sun);
                scene.add(new THREE.HemisphereLight(0x88ccff, 0x446633, 0.6));
                dbg('Scene + lighting ready ‚úì');

                // ‚îÄ‚îÄ Ground / Ocean fallback ‚îÄ‚îÄ
                const gnd = new THREE.Mesh(
                    new THREE.PlaneGeometry(80000, 80000),
                    new THREE.MeshLambertMaterial({ color: 0x4a7a3f })
                );
                gnd.rotation.x = -Math.PI / 2; gnd.position.y = -3; scene.add(gnd);

                const sea = new THREE.Mesh(
                    new THREE.PlaneGeometry(200000, 200000),
                    new THREE.MeshPhongMaterial({ color: 0x1a6090, transparent: true, opacity: 0.75, shininess: 80 })
                );
                sea.rotation.x = -Math.PI / 2; sea.position.y = -5; scene.add(sea);

                // ‚îÄ‚îÄ Coordinate Pivot ‚îÄ‚îÄ
                // 3D Tiles are in ECEF. We create a matrix to transform ECEF ‚Üí local ENU at Santa Cruz.
                pivotMat = enuMat(LAT, LNG, 0);
                const invPivot = pivotMat.clone().invert();
                dbg('Pivot matrix ready ‚úì');

                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                //  3D Tiles Renderer Setup
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                status('Creating TilesRenderer‚Ä¶');

                const rootUrl = `https://tile.googleapis.com/v1/3dtiles/root.json`;
                if (GoogleCloudAuthPlugin) {
                    // ‚îÄ‚îÄ Method A: Use GoogleCloudAuthPlugin (preferred) ‚îÄ‚îÄ
                    dbg('Using GoogleCloudAuthPlugin with ' + rootUrl);
                    tiles = new TilesRenderer(rootUrl);
                    tiles.registerPlugin(new GoogleCloudAuthPlugin({ apiToken: apiKey }));
                } else {
                    // ‚îÄ‚îÄ Method B: Direct URL with API key ‚îÄ‚îÄ
                    dbg('Falling back to direct URL approach', 'warn');
                    tiles = new TilesRenderer(`${rootUrl}?key=${apiKey}`);
                }

                // Apply the inverse pivot to the tiles group so ECEF tiles
                // appear in our local ENU coordinate system
                tiles.group.matrixAutoUpdate = false;
                tiles.group.matrix.copy(invPivot);
                tiles.group.updateMatrixWorld(true); // CRITICAL: Ensure matrixWorld is updated before tiles.update
                scene.add(tiles.group);
                dbg('TilesRenderer added to scene ‚úì local frame initialized');

                // Configure tile quality
                tiles.errorTarget = 12;
                tiles.errorThreshold = 40;
                tiles.maxDepth = 50;
                tiles.loadSiblings = true;
                dbg(`Tile config: errorTarget=${tiles.errorTarget}, maxDepth=${tiles.maxDepth}`);

                // Set up camera for tiles
                tiles.setCamera(camera);
                tiles.setResolutionFromRenderer(camera, renderer);
                dbg('Camera bound to TilesRenderer ‚úì');

                // ‚îÄ‚îÄ Listen for tile events ‚îÄ‚îÄ
                tiles.addEventListener('load-tile-set', (ev) => {
                    dbg(`Tileset loaded: ${ev?.url || 'root'}`);
                });
                tiles.addEventListener('tile-visibility-change', () => {
                    const stats = {
                        vis: tiles.visibleTiles?.size || 0,
                        active: tiles.activeTiles?.size || 0,
                        downloading: tiles.downloadManager?.downloading || 0
                    };
                    if (Math.random() < 0.05) dbg(`Tiles - Vis: ${stats.vis}, Active: ${stats.active}, Downloading: ${stats.downloading}`);
                });

                // ‚îÄ‚îÄ Wait for root tileset to resolve ‚îÄ‚îÄ
                status('Waiting for root tileset to load‚Ä¶');
                dbg('Waiting for tiles.root to become non-null‚Ä¶');

                let ready = false;
                const t0 = Date.now();
                while (!ready && (Date.now() - t0) < 25000) {
                    camera.updateMatrixWorld();
                    tiles.setCamera(camera);
                    tiles.setResolutionFromRenderer(camera, renderer);
                    tiles.update();
                    await sleep(100);
                    if (tiles.root) {
                        ready = true;
                        dbg('tiles.root is set ‚úì');
                    }
                }

                if (!ready) {
                    dbg('Root tileset did NOT load after 25s!', 'err');
                    dbg('Possible causes: Invalid API Key, Map Tiles API not enabled, or CORS blocked.', 'err');

                    // Check if it's a 403 (Forbidden) which usually means API not enabled or Key restriction
                    try {
                        const testUrl = `https://tile.googleapis.com/v1/3dtiles/root.json?key=${apiKey}`;
                        dbg(`Testing direct fetch: ${testUrl}`, 'warn');
                        const testResp = await fetch(testUrl);
                        const testBody = await testResp.text();
                        dbg(`Direct fetch status: ${testResp.status}`, testResp.ok ? 'ok' : 'err');
                        if (testResp.status === 403) {
                            dbg('Error 403: Ensure "Map Tiles API" is enabled in Google Cloud Console!', 'err');
                        }
                    } catch (fe) {
                        dbg(`Direct fetch also failed: ${fe.message}`, 'err');
                    }

                    throw new Error('Tileset failed to load. Check the debug panel for specific error codes.');
                }

                // ‚îÄ‚îÄ Let some tiles stream in ‚îÄ‚îÄ
                status('Streaming tiles around Santa Cruz‚Ä¶');
                for (let i = 0; i < 60; i++) {
                    camera.updateMatrixWorld();
                    tiles.setCamera(camera);
                    tiles.setResolutionFromRenderer(camera, renderer);
                    tiles.update();
                    renderer.render(scene, camera); // render during loading so tiles get requested
                    await sleep(80);
                    if (i % 10 === 0) {
                        const n = scene.children.length;
                        dbg(`Pre-load frame ${i}/60 ‚Äî scene children: ${n}`);
                        status(`Streaming tiles‚Ä¶ (${i}/60)`);
                    }
                }

                dbg('Pre-loading done ‚úì');
                const tileGroupKids = tiles.group.children.length;
                dbg(`Tiles group has ${tileGroupKids} direct children`);
                countMeshes(tiles.group);

                // ‚îÄ‚îÄ Input ‚îÄ‚îÄ
                setupInput();

                // ‚îÄ‚îÄ GO ‚îÄ‚îÄ
                $('loading').classList.remove('on');
                $('hud').classList.add('on');
                dbg('üéÆ Game started!');
                animate();

            } catch (err) {
                $('loading').classList.remove('on');
                console.error('Launch error:', err);
                dbg(`FATAL: ${err.message}`, 'err');
                dbg(`Stack: ${err.stack}`, 'err');
                alert('Error: ' + err.message);
                $('start-screen').style.display = 'flex';
            }
        }

        function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

        function countMeshes(obj) {
            let meshes = 0, verts = 0;
            obj.traverse(child => {
                if (child.isMesh) {
                    meshes++;
                    if (child.geometry) verts += child.geometry.attributes?.position?.count || 0;
                }
            });
            dbg(`Tile geometry: ${meshes} meshes, ${(verts / 1000).toFixed(0)}k vertices`);
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //  Input
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function setupInput() {
            document.addEventListener('keydown', e => { keys[e.code] = true; });
            document.addEventListener('keyup', e => { keys[e.code] = false; });
            renderer.domElement.addEventListener('click', () => renderer.domElement.requestPointerLock());
            document.addEventListener('pointerlockchange', () => {
                locked = document.pointerLockElement === renderer.domElement;
                $('cmsg').classList.toggle('hide', locked);
            });
            document.addEventListener('mousemove', e => {
                if (!locked) return;
                yaw -= e.movementX * SENS;
                pitch -= e.movementY * SENS;
                pitch = Math.max(-1.5, Math.min(1.5, pitch));
            });
            addEventListener('resize', () => {
                camera.aspect = innerWidth / innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(innerWidth, innerHeight);
            });
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //  Animation Loop
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        let frameN = 0;
        function animate() {
            requestAnimationFrame(animate);
            const dt = Math.min(clock.getDelta(), 0.1);
            frameN++;

            // ‚îÄ‚îÄ Camera orientation ‚îÄ‚îÄ
            const qY = new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0, 1, 0), yaw);
            const qP = new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(1, 0, 0), pitch);
            camera.quaternion.copy(qY).multiply(qP);

            // ‚îÄ‚îÄ Movement ‚îÄ‚îÄ
            const sp = SPD * ((keys['ShiftLeft'] || keys['ShiftRight']) ? SPRINT : 1);
            const fw = new THREE.Vector3(0, 0, -1).applyQuaternion(qY);
            const rt = new THREE.Vector3(1, 0, 0).applyQuaternion(qY);
            const ac = new THREE.Vector3();
            if (keys['KeyW']) ac.add(fw);
            if (keys['KeyS']) ac.sub(fw);
            if (keys['KeyD']) ac.add(rt);
            if (keys['KeyA']) ac.sub(rt);
            if (keys['Space'] || keys['KeyE']) ac.y += 1;
            if (keys['KeyQ']) ac.y -= 1;
            if (ac.lengthSq() > 0) { ac.normalize().multiplyScalar(sp); vel.lerp(ac, 8 * dt); }
            else { vel.multiplyScalar(1 - 6 * dt); }
            camera.position.add(vel.clone().multiplyScalar(dt));
            if (camera.position.y < 3) camera.position.y = 3;

            // ‚îÄ‚îÄ Update tiles ‚îÄ‚îÄ
            camera.updateMatrixWorld();
            tiles.setCamera(camera);
            tiles.setResolutionFromRenderer(camera, renderer);
            tiles.update();

            // ‚îÄ‚îÄ Render ‚îÄ‚îÄ
            renderer.render(scene, camera);

            // ‚îÄ‚îÄ HUD (every ~8 frames) ‚îÄ‚îÄ
            if (frameN % 8 === 0) {
                const ec = camera.position.clone().applyMatrix4(pivotMat);
                const g = e2g(ec.x, ec.y, ec.z);
                $('coords').textContent = `${Math.abs(g.lat).toFixed(4)}¬∞${g.lat >= 0 ? 'N' : 'S'}  ${Math.abs(g.lng).toFixed(4)}¬∞${g.lng >= 0 ? 'E' : 'W'}  Alt: ${Math.max(0, g.alt).toFixed(0)}m`;
                $('spd').textContent = vel.length().toFixed(1);

                // Count tiles
                let mc = 0;
                tiles.group.traverse(c => { if (c.isMesh) mc++; });
                $('htiles').textContent = `Meshes: ${mc}`;
            }

            // Periodic debug
            if (frameN % 300 === 0) {
                let mc = 0;
                tiles.group.traverse(c => { if (c.isMesh) mc++; });
                dbg(`Frame ${frameN}: ${mc} meshes, cam at (${camera.position.x.toFixed(0)}, ${camera.position.y.toFixed(0)}, ${camera.position.z.toFixed(0)})`);
            }
        }
    </script>
</body>

</html>