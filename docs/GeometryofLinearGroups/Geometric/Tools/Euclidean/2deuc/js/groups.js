// groups.js — Discrete subgroups of Isom(R^2)
// Each group has: name, rank, generators (as isometry objects), fundDomain, description

import {
    translation, rotation, reflection, reflectionLine, glideReflection,
    identity, compose
} from './math.js';

const PI = Math.PI;
const TAU = 2 * PI;

// ============================================================
// Fundamental domain shapes
// ============================================================
function rect(w, h) {
    return [[-w/2,-h/2],[w/2,-h/2],[w/2,h/2],[-w/2,h/2]];
}

function parallelogram(v1, v2) {
    return [[0,0], v1, [v1[0]+v2[0], v1[1]+v2[1]], v2];
}

function regularPolygon(n, r = 1) {
    const pts = [];
    for (let i = 0; i < n; i++) {
        const a = TAU * i / n - PI/2;
        pts.push([r * Math.cos(a), r * Math.sin(a)]);
    }
    return pts;
}

function triangle(p1, p2, p3) {
    return [p1, p2, p3];
}

// ============================================================
// RANK 0: Point groups C_n, D_n
// ============================================================
function makePointGroups() {
    const groups = [];
    for (let n = 1; n <= 12; n++) {
        // C_n: cyclic rotation group
        const gens_c = n === 1 ? [] : [rotation(TAU/n)];
        groups.push({
            id: `C${n}`,
            name: `C${subscript(n)}`,
            fullName: n === 1 ? 'Trivial group' : `Cyclic group of order ${n}`,
            rank: 0,
            generators: gens_c,
            genLabels: n === 1 ? [] : [`r (rotation ${Math.round(360/n)}°)`],
            fundDomain: n === 1
                ? [[-0.8,-0.8],[0.8,-0.8],[0.8,0.8],[-0.8,0.8]]
                : makeCnDomain(n),
            description: n === 1
                ? 'Only the identity — the whole plane is a fundamental domain.'
                : `Generated by rotation by 2π/${n}. The fundamental domain is a sector of angle 2π/${n}.`
        });
        // D_n: dihedral group
        if (n >= 1) {
            const gens_d = n === 1
                ? [reflection(0)]
                : [rotation(TAU/n), reflection(0)];
            const labels = n === 1
                ? ['σ (reflect across x-axis)']
                : [`r (rotation ${Math.round(360/n)}°)`, 'σ (reflect across x-axis)'];
            groups.push({
                id: `D${n}`,
                name: `D${subscript(n)}`,
                fullName: `Dihedral group of order ${2*n}`,
                rank: 0,
                generators: gens_d,
                genLabels: labels,
                fundDomain: makeDnDomain(n),
                description: `Generated by rotation by 2π/${n} and a reflection. Has ${n} rotations and ${n} reflections.`
            });
        }
    }
    return groups;
}

function makeCnDomain(n) {
    const angle = TAU / n;
    const r = 1.5;
    const pts = [[0,0]];
    const steps = 12;
    for (let i = 0; i <= steps; i++) {
        const a = (i / steps) * angle;
        pts.push([r * Math.cos(a), r * Math.sin(a)]);
    }
    return pts;
}

function makeDnDomain(n) {
    const angle = PI / n;
    const r = 1.5;
    const pts = [[0,0]];
    const steps = 8;
    for (let i = 0; i <= steps; i++) {
        const a = (i / steps) * angle;
        pts.push([r * Math.cos(a), r * Math.sin(a)]);
    }
    return pts;
}

// ============================================================
// RANK 1: Frieze groups (7 total)
// ============================================================
function makeFriezeGroups() {
    const t = 1; // translation distance
    const h = 0.5; // half-height of strip

    return [
        {
            id: 'p1_frieze',
            name: 'p1',
            fullName: 'Hop',
            rank: 1,
            generators: [translation(t, 0)],
            genLabels: ['t (translate by 1)'],
            fundDomain: rect(t, 2*h),
            description: 'Translation only. The simplest frieze group.'
        },
        {
            id: 'p11m',
            name: 'p11m',
            fullName: 'Jump',
            rank: 1,
            generators: [translation(t, 0), reflectionLine(0, 0, 0)],
            genLabels: ['t (translate)', 'σ (reflect across axis)'],
            fundDomain: [[0, 0], [t, 0], [t, h], [0, h]],
            description: 'Translation + reflection across the frieze axis.'
        },
        {
            id: 'p11g',
            name: 'p11g',
            fullName: 'Sidle',
            rank: 1,
            generators: [translation(t, 0), glideReflection(0, t/2, 0, 0)],
            genLabels: ['t (translate)', 'g (glide reflection)'],
            fundDomain: [[0, 0], [t, 0], [t, h], [0, h]],
            description: 'Translation + glide reflection along the axis.'
        },
        {
            id: 'p2_frieze',
            name: 'p2',
            fullName: 'Spinning hop',
            rank: 1,
            generators: [translation(t, 0), rotation(PI, 0, 0)],
            genLabels: ['t (translate)', 'r (rotate 180°)'],
            fundDomain: [[0, 0], [t, 0], [t, h], [0, h]],
            description: 'Translation + 180° rotation (half-turn).'
        },
        {
            id: 'p2mm_frieze',
            name: 'p2mm',
            fullName: 'Spinning sidle',
            rank: 1,
            generators: [translation(t, 0), reflectionLine(0, 0, 0), reflectionLine(PI/2, 0, 0)],
            genLabels: ['t (translate)', 'σ₁ (reflect horiz)', 'σ₂ (reflect vert)'],
            fundDomain: [[0, 0], [t/2, 0], [t/2, h], [0, h]],
            description: 'Translation + horizontal and vertical reflections.'
        },
        {
            id: 'p2mg_frieze',
            name: 'p2mg',
            fullName: 'Spinning jump',
            rank: 1,
            generators: [translation(t, 0), reflectionLine(PI/2, 0, 0), glideReflection(0, t/2, 0, 0)],
            genLabels: ['t (translate)', 'σ (reflect vert)', 'g (glide)'],
            fundDomain: [[0, 0], [t/2, 0], [t/2, h], [0, h]],
            description: 'Translation + vertical reflection + glide reflection.'
        },
        {
            id: 'p2gm_frieze',
            name: 'p2gm',
            fullName: 'Step',
            rank: 1,
            generators: [translation(t, 0), reflectionLine(0, 0, 0), rotation(PI, t/2, 0)],
            genLabels: ['t (translate)', 'σ (reflect horiz)', 'r (rotate 180° at midpoint)'],
            fundDomain: [[0, 0], [t/2, 0], [t/2, h], [0, h]],
            description: 'Translation + horizontal reflection + 180° rotation.'
        }
    ];
}

// ============================================================
// RANK 2: Wallpaper groups (17 total)
// ============================================================
function makeWallpaperGroups() {
    const s3 = Math.sqrt(3);

    return [
        {
            id: 'p1',
            name: 'p1',
            fullName: 'Oblique lattice, no extra symmetry',
            rank: 2,
            generators: [translation(1, 0), translation(0.3, 1)],
            genLabels: ['t₁ (translate)', 't₂ (translate)'],
            fundDomain: parallelogram([1,0], [0.3,1]),
            description: 'Two independent translations. The simplest wallpaper group.'
        },
        {
            id: 'p2',
            name: 'p2',
            fullName: '180° rotation centers',
            rank: 2,
            generators: [translation(1, 0), translation(0, 1), rotation(PI, 0, 0)],
            genLabels: ['t₁', 't₂', 'r (rotate 180°)'],
            fundDomain: [[0,0],[1,0],[1,0.5],[0,0.5]],
            description: 'Two translations + 180° rotation. Four distinct rotation centers per cell.'
        },
        {
            id: 'pm',
            name: 'pm',
            fullName: 'Parallel mirrors',
            rank: 2,
            generators: [translation(1, 0), translation(0, 1), reflectionLine(PI/2, 0, 0)],
            genLabels: ['t₁', 't₂', 'σ (reflect)'],
            fundDomain: [[0,0],[0.5,0],[0.5,1],[0,1]],
            description: 'Translations + reflection. Mirror lines are all parallel.'
        },
        {
            id: 'pg',
            name: 'pg',
            fullName: 'Parallel glide reflections',
            rank: 2,
            generators: [translation(1, 0), translation(0, 1), glideReflection(PI/2, 0.5, 0, 0)],
            genLabels: ['t₁', 't₂', 'g (glide reflection)'],
            fundDomain: [[0,0],[0.5,0],[0.5,1],[0,1]],
            description: 'Translations + glide reflection. No true mirrors.'
        },
        {
            id: 'cm',
            name: 'cm',
            fullName: 'Staggered mirrors',
            rank: 2,
            generators: [translation(1, 0), translation(0.5, 0.5), reflectionLine(PI/2, 0, 0)],
            genLabels: ['t₁', 't₂', 'σ (reflect)'],
            fundDomain: [[0,0],[0.5,0],[0.5,0.5],[0,0.5]],
            description: 'Rhombic lattice with reflection. Mirrors + glide reflections interleave.'
        },
        {
            id: 'p2mm',
            name: 'p2mm',
            fullName: 'Perpendicular mirrors',
            rank: 2,
            generators: [translation(1, 0), translation(0, 1), reflectionLine(0, 0, 0), reflectionLine(PI/2, 0, 0)],
            genLabels: ['t₁', 't₂', 'σ₁ (horiz)', 'σ₂ (vert)'],
            fundDomain: [[0,0],[0.5,0],[0.5,0.5],[0,0.5]],
            description: 'Rectangular lattice with two perpendicular mirror families.'
        },
        {
            id: 'p2mg',
            name: 'p2mg',
            fullName: 'Mirrors + glides',
            rank: 2,
            generators: [translation(1, 0), translation(0, 1), reflectionLine(PI/2, 0, 0), glideReflection(0, 0.5, 0, 0)],
            genLabels: ['t₁', 't₂', 'σ (vert mirror)', 'g (horiz glide)'],
            fundDomain: [[0,0],[0.5,0],[0.5,0.5],[0,0.5]],
            description: 'Mirrors in one direction, glide reflections in the other.'
        },
        {
            id: 'p2gg',
            name: 'p2gg',
            fullName: 'Perpendicular glides',
            rank: 2,
            generators: [translation(1, 0), translation(0, 1), glideReflection(0, 0.5, 0, 0), glideReflection(PI/2, 0.5, 0, 0)],
            genLabels: ['t₁', 't₂', 'g₁ (horiz glide)', 'g₂ (vert glide)'],
            fundDomain: [[0,0],[0.5,0],[0.5,0.5],[0,0.5]],
            description: 'Two perpendicular glide reflections, no true mirrors.'
        },
        {
            id: 'c2mm',
            name: 'c2mm',
            fullName: 'Rhombic with mirrors',
            rank: 2,
            generators: [translation(1, 0), translation(0.5, 0.5), reflectionLine(0, 0, 0), reflectionLine(PI/2, 0, 0)],
            genLabels: ['t₁', 't₂', 'σ₁ (horiz)', 'σ₂ (vert)'],
            fundDomain: [[0,0],[0.5,0],[0.25,0.25],[0,0.25]],
            description: 'Centered rectangular lattice with two perpendicular mirrors.'
        },
        {
            id: 'p4',
            name: 'p4',
            fullName: '90° rotations',
            rank: 2,
            generators: [translation(1, 0), translation(0, 1), rotation(PI/2, 0, 0)],
            genLabels: ['t₁', 't₂', 'r (rotate 90°)'],
            fundDomain: triangle([0,0],[1,0],[0.5,0.5]),
            description: 'Square lattice with 90° rotation symmetry.'
        },
        {
            id: 'p4mm',
            name: 'p4mm',
            fullName: '90° + mirrors on axes',
            rank: 2,
            generators: [translation(1, 0), translation(0, 1), rotation(PI/2, 0, 0), reflectionLine(0, 0, 0)],
            genLabels: ['t₁', 't₂', 'r (90°)', 'σ (mirror)'],
            fundDomain: triangle([0,0],[0.5,0],[0.5,0.5]),
            description: 'Square lattice + 90° rotation + reflections along axes.'
        },
        {
            id: 'p4gm',
            name: 'p4gm',
            fullName: '90° + mirrors on diagonals',
            rank: 2,
            generators: [translation(1, 0), translation(0, 1), rotation(PI/2, 0.5, 0.5), reflectionLine(PI/4, 0, 0)],
            genLabels: ['t₁', 't₂', 'r (90° at center)', 'σ (diagonal mirror)'],
            fundDomain: triangle([0,0],[0.5,0],[0.5,0.5]),
            description: 'Square lattice + 90° rotation at cell center + diagonal mirrors.'
        },
        {
            id: 'p3',
            name: 'p3',
            fullName: '120° rotations',
            rank: 2,
            generators: [translation(1, 0), translation(0.5, s3/2), rotation(TAU/3, 0, 0)],
            genLabels: ['t₁', 't₂', 'r (rotate 120°)'],
            fundDomain: triangle([0,0], [1,0], [0.5, s3/6]),
            description: 'Hexagonal lattice with 120° rotation symmetry.'
        },
        {
            id: 'p3m1',
            name: 'p3m1',
            fullName: '120° + mirrors through rotation centers',
            rank: 2,
            generators: [translation(1, 0), translation(0.5, s3/2), rotation(TAU/3, 0, 0), reflectionLine(PI/6, 0, 0)],
            genLabels: ['t₁', 't₂', 'r (120°)', 'σ (mirror)'],
            fundDomain: triangle([0,0], [0.5, 0], [0.5, s3/6]),
            description: 'Hexagonal lattice + 120° rotation + mirrors through vertices.'
        },
        {
            id: 'p31m',
            name: 'p31m',
            fullName: '120° + mirrors not all through centers',
            rank: 2,
            generators: [translation(1, 0), translation(0.5, s3/2), rotation(TAU/3, 1/3, s3/6), reflectionLine(0, 0, 0)],
            genLabels: ['t₁', 't₂', 'r (120° at centroid)', 'σ (mirror)'],
            fundDomain: triangle([0,0], [0.5, 0], [1/3, s3/6]),
            description: 'Hexagonal lattice + 120° rotation off vertex + mirrors.'
        },
        {
            id: 'p6',
            name: 'p6',
            fullName: '60° rotations',
            rank: 2,
            generators: [translation(1, 0), translation(0.5, s3/2), rotation(PI/3, 0, 0)],
            genLabels: ['t₁', 't₂', 'r (rotate 60°)'],
            fundDomain: triangle([0,0], [0.5, 0], [0.5, s3/6]),
            description: 'Hexagonal lattice with 60° rotation symmetry.'
        },
        {
            id: 'p6mm',
            name: 'p6mm',
            fullName: '60° + mirrors',
            rank: 2,
            generators: [translation(1, 0), translation(0.5, s3/2), rotation(PI/3, 0, 0), reflectionLine(0, 0, 0)],
            genLabels: ['t₁', 't₂', 'r (60°)', 'σ (mirror)'],
            fundDomain: triangle([0,0], [0.5, 0], [0.25, s3/12]),
            description: 'Hexagonal lattice + 60° rotation + all mirrors. The most symmetric wallpaper group.'
        }
    ];
}

function subscript(n) {
    const subs = '₀₁₂₃₄₅₆₇₈₉';
    return String(n).split('').map(d => subs[parseInt(d)]).join('');
}

// ============================================================
// Export all groups
// ============================================================
const pointGroups = makePointGroups();
const friezeGroups = makeFriezeGroups();
const wallpaperGroups = makeWallpaperGroups();

export const allGroups = [...pointGroups, ...friezeGroups, ...wallpaperGroups];

export function getGroupById(id) {
    return allGroups.find(g => g.id === id);
}

export function getGroupsByRank(rank) {
    return allGroups.filter(g => g.rank === rank);
}
